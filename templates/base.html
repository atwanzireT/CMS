{% load static %}
<!DOCTYPE html>
<html lang="en" class="h-full" x-data="appShell()" x-init="init()" :class="{ 'dark': theme==='dark' }">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}GreatPearl Coffee{% endblock %}</title>

  {{ form.media.css }}

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'], display: ['Playfair Display','serif'] },
          colors: {
            primary: {50:'#f0fdfa',100:'#ccfbf1',200:'#99f6e4',300:'#5eead4',400:'#2dd4bf',500:'#14b8a6',600:'#0d9488',700:'#0f766e',800:'#115e59',900:'#134e4a'},
            accent: {100:'#fef3c7',200:'#fde68a',300:'#fcd34d',400:'#fbbf24',500:'#f59e0b',600:'#d97706',700:'#b45309'},
            dark:   {50:'#f9fafb',100:'#f3f4f6',200:'#e5e7eb',300:'#d1d5db',400:'#9ca3af',500:'#6b7280',600:'#4b5563',700:'#374151',800:'#1f2937',900:'#0f172a'}
          },
          boxShadow: {
            soft: '0 10px 30px rgba(2, 6, 23, 0.06)',
            glow: '0 0 0 3px rgba(20,184,166,.12)'
          },
          backdropBlur: { xs: '2px' },
          animation: { 'fade-in': 'fadeIn .35s ease-out','slide-up': 'slideUp .35s ease-out','float':'float 5s ease-in-out infinite' },
          keyframes: {
            fadeIn:{'0%':{opacity:0},'100%':{opacity:1}},
            slideUp:{'0%':{transform:'translateY(8px)',opacity:0},'100%':{transform:'translateY(0)',opacity:1}},
            float:{'0%,100%':{transform:'translateY(0)'},'50%':{transform:'translateY(-6px)'}},
          }
        }
      }
    }
  </script>

  <!-- Alpine -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Icons / Fonts -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">

  <style>
    [x-cloak]{display:none!important}
    ::-webkit-scrollbar{width:8px;height:8px}
    ::-webkit-scrollbar-thumb{background:linear-gradient(135deg,#14b8a6,#0f766e);border-radius:10px}
    ::-webkit-scrollbar-track{background:rgba(148,163,184,.2)}
    .glass{background:rgba(255,255,255,.7);backdrop-filter:blur(18px) saturate(160%);border:1px solid rgba(148,163,184,.25)}
    .dark .glass{background:rgba(2,6,23,.6);border-color:rgba(51,65,85,.5)}
    .navlink{display:flex;align-items:center;gap:.7rem;padding:.65rem .8rem;border-radius:.8rem;color:#334155}
    .dark .navlink{color:#cbd5e1}
    .navlink:hover{background:rgba(20,184,166,.10)}
    .dark .navlink:hover{background:rgba(20,184,166,.15)}
    .navlink.is-active{background:linear-gradient(90deg,rgba(20,184,166,.18),rgba(20,184,166,0));color:#0f766e}
    .dark .navlink.is-active{color:#5eead4}
    .coffee-pattern{background-image:radial-gradient(circle at 20% 15%,rgba(20,184,166,.10)0%,transparent 35%),radial-gradient(circle at 85% 80%,rgba(245,158,11,.10)0%,transparent 40%)}
  </style>

  {% block extra_head %}{% endblock %}
</head>

<body class="h-full bg-slate-50 dark:bg-dark-900 text-slate-900 dark:text-slate-100 coffee-pattern">
  <!-- Floating dark mode toggle -->
  <button @click="toggleTheme" class="fixed bottom-6 right-6 z-50 w-12 h-12 rounded-2xl glass shadow-soft flex items-center justify-center hover:shadow-glow transition-all animate-float" title="Toggle theme">
    <i :class="theme==='dark' ? 'fa-solid fa-sun text-amber-300' : 'fa-solid fa-moon text-slate-600'"></i>
  </button>

  {% include 'partials/topbar.html' %}

  <!-- Sidebar -->
  <aside id="sidebar"
    class="fixed left-0 top-16 h-[calc(100vh-4rem)] transition-all duration-300 z-40 overflow-y-auto bg-transparent"
    :class="[
      sidebarCollapsed ? 'lg:w-20' : 'lg:w-72',     // desktop width
      'w-72',                                       // mobile width
      sidebarOpen ? 'translate-x-0' : '-translate-x-full', // mobile slide
      'lg:translate-x-0'                            // desktop shown
    ]">
    <div class="glass h-full border-r">
      {% include 'partials/sidenavigation.html' %}
    </div>
  </aside>

  <!-- Mobile overlay -->
  <div x-show="sidebarOpen" x-transition.opacity class="fixed inset-0 bg-black/50 backdrop-blur-xs z-30 lg:hidden" @click="closeSidebar()"></div>

  <!-- Main -->
  <main class="pt-16 mt-5 min-h-screen transition-all duration-300" :class="sidebarCollapsed ? 'lg:pl-20' : 'lg:pl-72'">
    <!-- Messages -->
    {% if messages %}
    <div class="p-4 sm:p-6">
      <div class="max-w-[95%] mx-auto space-y-3">
        {% for message in messages %}
          <div class="glass border rounded-2xl p-4 shadow-soft animate-slide-up flex items-start gap-3"
               {% if message.tags == 'success' %}style="--accent: #16a34a"{% elif message.tags == 'error' %}style="--accent:#dc2626"{% else %}style="--accent:#0284c7"{% endif %}>
            <div class="w-9 h-9 rounded-xl flex items-center justify-center" style="background: color-mix(in oklab, var(--accent) 12%, transparent); color: var(--accent);">
              <i class="fa-solid {% if message.tags == 'success' %}fa-check{% elif message.tags == 'error' %}fa-circle-exclamation{% else %}fa-circle-info{% endif %}"></i>
            </div>
            <p class="flex-1 text-sm">{{ message }}</p>
            <button class="w-8 h-8 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800" onclick="this.closest('div').remove()"><i class="fa-solid fa-xmark"></i></button>
          </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Header / Breadcrumb + user pill -->
    <section class="px-1 sm:px-2">
      <div class="max-w-[95%] mx-auto">
        <div class="glass border rounded-2xl p-5 sm:p-6 shadow-soft animate-fade-in">
          <div class="flex flex-col md:flex-row md:items-center gap-4 md:gap-6 justify-between">
            <nav class="flex items-center gap-2 text-sm">
              <a href="{% url 'store:home' %}" class="inline-flex items-center gap-2 text-primary-700 dark:text-primary-300 hover:underline">
                <span class="w-7 h-7 rounded-lg bg-primary-500 text-white inline-flex items-center justify-center"><i class="fa-solid fa-house"></i></span>
                <span>Dashboard</span>
              </a>
              {% block breadcrumb %}{% endblock %}
            </nav>
            <div class="flex items-center gap-3">
              <div class="px-3 py-1.5 rounded-xl bg-slate-100 dark:bg-slate-800">
                <div class="flex items-center gap-2">
                  <img src="https://ui-avatars.com/api/?name={{ request.user.get_username }}&background=0d9488&color=fff&size=128&font-size=0.5&bold=true" alt="avatar" class="w-8 h-8 rounded-full border-2 border-white dark:border-slate-700"/>
                  <div class="leading-tight">
                    <div class="text-sm font-semibold">{{ request.user.get_full_name|default:request.user.username }}</div>
                    <div class="text-xs text-slate-500 dark:text-slate-400 capitalize">{{ user_role|default:"user" }}</div>
                  </div>
                </div>
              </div>
              <div class="hidden sm:flex gap-2">
                <button @click="reload()" class="px-3 py-2 rounded-xl border hover:bg-slate-50 dark:border-slate-700 dark:hover:bg-slate-800"><i class="fa-solid fa-rotate"></i></button>
                <button @click="toggleTheme" class="px-3 py-2 rounded-xl border hover:bg-slate-50 dark:border-slate-700 dark:hover:bg-slate-800"><i :class="theme==='dark'?'fa-solid fa-sun':'fa-solid fa-moon'"></i></button>
              </div>
            </div>
          </div>
          {% block header_actions %}{% endblock %}
        </div>
      </div>
    </section>

    <!-- Page Content -->
    <section class="px-1 sm:px-2 py-6">
      <div class="max-w-[95%] mx-auto">
        {% block content %}{% endblock %}
      </div>
    </section>

    <footer class="px-4 sm:px-6 pb-8">
      <div class="max-w-[95%] mx-auto text-xs text-slate-500 dark:text-slate-400">© {{ now|date:"Y" }} Great Pearl Coffee Factory · All rights reserved</div>
    </footer>
  </main>

  {% block extra_js %}{% endblock %}

  <!-- jQuery (optional) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  {{ form.media.js }}

  <script>
    function appShell(){
      return {
        theme: 'light',
        sidebarOpen: false,        // mobile drawer
        sidebarCollapsed: false,   // desktop narrow mode

        init(){
          const storedTheme = localStorage.getItem('theme');
          this.theme = storedTheme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
          document.documentElement.classList.toggle('dark', this.theme==='dark');

          // Restore collapse state
          this.sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';

          // Highlight active nav
          try {
            document.querySelectorAll('aside nav a').forEach(a => {
              const p = location.pathname.replace(/\/+$/,'');
              const h = (a.getAttribute('href')||'').replace(/\/+$/,'');
              if (h && (h===p || p.startsWith(h+'/'))) a.classList.add('is-active');
            });
          } catch {}
        },

        toggleTheme(){
          this.theme = this.theme==='dark' ? 'light' : 'dark';
          localStorage.setItem('theme', this.theme);
          document.documentElement.classList.toggle('dark', this.theme==='dark');
        },

        // Sidebar controls
        openSidebar(){ this.sidebarOpen = true },
        closeSidebar(){ this.sidebarOpen = false },
        toggleSidebarMobile(){ this.sidebarOpen = !this.sidebarOpen },
        toggleSidebarDesktop(){
          this.sidebarCollapsed = !this.sidebarCollapsed;
          localStorage.setItem('sidebarCollapsed', String(this.sidebarCollapsed));
        },

        reload(){ location.reload() },
      }
    }
  </script>
</body>
</html>
