{% extends "base.html" %}
{% load humanize %}

{% block title %}Finance Dashboard - GreatPearl Coffee{% endblock %}

{% block page_title %}Finance Dashboard{% endblock %}

{% block content %}
<div class="container">

  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
    <div>
      <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Finance Overview</h1>
      <p class="text-sm text-gray-600 dark:text-gray-400">
        Period: {{ period.month_start|date:"M d, Y" }} â€” {{ period.month_end|date:"M d, Y" }}
      </p>
      <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">
        Only assessed purchases are payable.
      </p>
    </div>
    <div class="flex items-center gap-2">
      <a href="{% url 'store_dashboard' %}"
         class="px-3 py-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
        Back to Store
      </a>
      <button onclick="window.print()"
        class="px-3 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm">
        Print
      </button>
    </div>
  </div>

  <!-- Stat cards -->
  <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 mb-8">
    <!-- Monthly Revenue -->
    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-5">
      <div class="flex items-start justify-between">
        <div>
          <p class="text-sm text-gray-500 dark:text-gray-400">Monthly Revenue</p>
          <p class="mt-2 text-2xl font-bold text-gray-900 dark:text-white">
            UGX {{ metrics.monthly_revenue|floatformat:0|intcomma }}
          </p>
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">All sales this month</p>
        </div>
        <div class="p-2 rounded-xl bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300">
          <i class="fas fa-chart-line"></i>
        </div>
      </div>
    </div>

    <!-- Cash In / Out -->
    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-5">
      <div class="flex items-start justify-between">
        <div>
          <p class="text-sm text-gray-500 dark:text-gray-400">Cash Flow (This Month)</p>
          <div class="mt-2 grid grid-cols-2 gap-4">
            <div>
              <p class="text-xs text-gray-500 dark:text-gray-400">Inflow</p>
              <p class="text-lg font-semibold text-gray-900 dark:text-white">
                UGX {{ metrics.cash_inflow|floatformat:0|intcomma }}
              </p>
            </div>
            <div>
              <p class="text-xs text-gray-500 dark:text-gray-400">Outflow</p>
              <p class="text-lg font-semibold text-gray-900 dark:text-white">
                UGX {{ metrics.cash_outflow|floatformat:0|intcomma }}
              </p>
            </div>
          </div>
          <div class="mt-3">
            <p class="text-xs text-gray-500 dark:text-gray-400">Net Cash Flow</p>
            <p class="text-xl font-bold {% if metrics.net_cash_flow|floatformat:0|add:'0' < 0 %}text-red-600{% else %}text-emerald-600{% endif %}">
              UGX {{ metrics.net_cash_flow|floatformat:0|intcomma }}
            </p>
          </div>
        </div>
        <div class="p-2 rounded-xl bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300">
          <i class="fas fa-exchange-alt"></i>
        </div>
      </div>
    </div>

    <!-- Available Cash + Totals -->
    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-5">
      <div class="flex items-start justify-between">
        <div class="w-full">
          <p class="text-sm text-gray-500 dark:text-gray-400">Available Cash (This Month)</p>
          <p class="mt-2 text-2xl font-bold {% if metrics.available_cash|floatformat:0|add:'0' < 0 %}text-red-600{% else %}text-emerald-600{% endif %}">
            UGX {{ metrics.available_cash|floatformat:0|intcomma }}
          </p>
          <div class="mt-4 grid grid-cols-2 gap-4">
            <div>
              <p class="text-xs text-gray-500 dark:text-gray-400">Pending Supplier Payments</p>
              <p class="text-base font-semibold text-gray-900 dark:text-white">
                UGX {{ metrics.pending_payments_total|floatformat:0|intcomma }}
              </p>
            </div>
            <div>
              <p class="text-xs text-gray-500 dark:text-gray-400">Completed Supplier Payments</p>
              <p class="text-base font-semibold text-gray-900 dark:text-white">
                UGX {{ metrics.completed_payments_total|floatformat:0|intcomma }}
              </p>
            </div>
          </div>
        </div>
        <div class="p-2 rounded-xl bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300">
          <i class="fas fa-wallet"></i>
        </div>
      </div>
    </div>
  </section>

  <!-- Tables -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Pending Payments -->
    <section class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
          Pending Supplier Payments
        </h2>
        <span class="px-3 py-1 text-xs rounded-full bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300">
          {{ lists.pending_payments|length }} items
        </span>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full">
          <thead class="bg-gray-50 dark:bg-gray-700/40 text-xs uppercase text-gray-500 dark:text-gray-400">
            <tr>
              <th class="px-6 py-3 text-left">Supplier</th>
              <th class="px-6 py-3 text-left">Coffee</th>
              <th class="px-6 py-3 text-right">Quantity</th>
              <th class="px-6 py-3 text-right">Amount</th>
              <th class="px-6 py-3 text-right">Status</th>
              <th class="px-6 py-3 text-right">Action</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
            {% for row in lists.pending_payments %}
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/30">
              <td class="px-6 py-3">
                <div class="text-sm font-medium text-gray-900 dark:text-white">{{ row.supplier.name }}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">Purchased {{ row.purchase_date|date:"M d, Y" }}</div>
              </td>
              <td class="px-6 py-3 text-sm text-gray-700 dark:text-gray-300">
                {{ row.coffee_type }} â€¢ {{ row.coffee_category }}
              </td>
              <td class="px-6 py-3 text-right text-sm text-gray-900 dark:text-white">
                {{ row.quantity|floatformat:0|intcomma }} kg
              </td>
              <td class="px-6 py-3 text-right text-sm font-semibold text-amber-700 dark:text-amber-300">
                UGX {{ row.amount|floatformat:0|intcomma }}
              </td>
              <td class="px-6 py-3 text-right">
                <span class="px-2 py-1 text-xs rounded-full
                  {% if row.status == 'Paid' %} bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300
                  {% elif row.status == 'Partial' %} bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300
                  {% else %} bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300 {% endif %}">
                  {{ row.status }}
                </span>
              </td>
              <td class="px-6 py-3 text-right">
                <a href="{% url 'purchase_detail' row.id %}"
                   class="inline-flex items-center px-3 py-1.5 text-xs bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                  View
                </a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                No pending payments ðŸŽ‰
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 text-right">
        <span class="text-sm text-gray-600 dark:text-gray-400 mr-2">Total Pending:</span>
        <span class="text-base font-semibold text-gray-900 dark:text-white">
          UGX {{ metrics.pending_payments_total|floatformat:0|intcomma }}
        </span>
      </div>
    </section>

    <!-- Completed Payments -->
    <section class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
          Completed Supplier Payments
        </h2>
        <span class="px-3 py-1 text-xs rounded-full bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300">
          {{ lists.completed_payments|length }} items
        </span>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full">
          <thead class="bg-gray-50 dark:bg-gray-700/40 text-xs uppercase text-gray-500 dark:text-gray-400">
            <tr>
              <th class="px-6 py-3 text-left">Supplier</th>
              <th class="px-6 py-3 text-left">Coffee</th>
              <th class="px-6 py-3 text-right">Quantity</th>
              <th class="px-6 py-3 text-right">Amount</th>
              <th class="px-6 py-3 text-right">Status</th>
              <th class="px-6 py-3 text-right">Action</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
            {% for row in lists.completed_payments %}
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/30">
              <td class="px-6 py-3">
                <div class="text-sm font-medium text-gray-900 dark:text-white">{{ row.supplier.name }}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">Purchased {{ row.purchase_date|date:"M d, Y" }}</div>
              </td>
              <td class="px-6 py-3 text-sm text-gray-700 dark:text-gray-300">
                {{ row.coffee_type }} â€¢ {{ row.coffee_category }}
              </td>
              <td class="px-6 py-3 text-right text-sm text-gray-900 dark:text-white">
                {{ row.quantity|floatformat:0|intcomma }} kg
              </td>
              <td class="px-6 py-3 text-right text-sm font-semibold text-emerald-700 dark:text-emerald-300">
                UGX {{ row.amount|floatformat:0|intcomma }}
              </td>
              <td class="px-6 py-3 text-right">
                <span class="px-2 py-1 text-xs rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300">
                  {{ row.status }}
                </span>
              </td>
              <td class="px-6 py-3 text-right">
                <a href="{% url 'purchase_detail' row.id %}"
                   class="inline-flex items-center px-3 py-1.5 text-xs bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                  View
                </a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                No completed payments yet.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 text-right">
        <span class="text-sm text-gray-600 dark:text-gray-400 mr-2">Total Completed:</span>
        <span class="text-base font-semibold text-gray-900 dark:text-white">
          UGX {{ metrics.completed_payments_total|floatformat:0|intcomma }}
        </span>
      </div>
    </section>
  </div>

</div>

<!-- (Optional) tiny helper for print-friendly background colors -->
<style>
@media print {
  .dark * { color: #000 !important; background: #fff !important; }
}
</style>
{% endblock %}
