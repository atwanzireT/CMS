{% extends "base.html" %}
{% load static %}

{% block title %}Quality Assessment – GreatPearl Coffee{% endblock %}

{% block content %}
<div class="mx-auto max-w-6xl px-4 py-8">
  <!-- Page Header -->
  <div class="mb-8 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <h1 class="text-3xl font-light tracking-wide text-gray-900 dark:text-green-50">Quality Assessment</h1>
      <p class="mt-2 text-sm text-gray-600 dark:text-green-100/70">Coffee: <span class="font-medium text-gray-800 dark:text-green-50">{{ coffee_purchase }}</span></p>
    </div>
    <div class="flex gap-3">
      <a href="{% url 'assessment:assessment_list' %}" class="inline-flex items-center rounded-lg border border-gray-300 dark:border-green-700/30 bg-transparent px-5 py-2.5 text-sm font-medium text-gray-700 dark:text-green-100/80 hover:bg-gray-50 dark:hover:bg-green-900/20 transition-all duration-200">
        <i class="fas fa-arrow-left mr-2"></i> Back to list
      </a>
      <button id="submitBtn" form="assessmentForm" type="submit" class="inline-flex items-center rounded-lg bg-green-700 px-5 py-2.5 text-sm font-medium text-white hover:bg-green-800 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 dark:focus:ring-offset-gray-900 transition-all duration-200 shadow-md hover:shadow-lg">
        <i class="fas fa-check-circle mr-2"></i> Submit Assessment
      </button>
    </div>
  </div>

  {% if form.non_field_errors %}
    <div class="mb-6 rounded-xl border border-red-200 dark:border-red-800/50 bg-red-50 dark:bg-red-900/20 p-4 text-sm text-red-800 dark:text-red-200 shadow-sm">
      <div class="flex items-center">
        <i class="fas fa-exclamation-circle mr-2"></i>
        {{ form.non_field_errors }}
      </div>
    </div>
  {% endif %}

  <form id="assessmentForm" action="" method="post" class="grid grid-cols-1 gap-8 lg:grid-cols-12" novalidate>
    {% csrf_token %}

    <!-- LEFT: Inputs -->
    <section class="lg:col-span-7">
      <div class="rounded-2xl border border-gray-200 dark:border-green-700/30 bg-white dark:bg-gray-900 p-6 shadow-lg">
        <div class="mb-6 flex items-center border-b border-gray-100 dark:border-green-700/20 pb-4">
          <div class="flex h-10 w-10 items-center justify-center rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-200 mr-3">
            <i class="fas fa-clipboard-list"></i>
          </div>
          <h2 class="text-xl font-medium text-gray-900 dark:text-green-50">Input Metrics</h2>
        </div>

        <div class="grid grid-cols-1 gap-5 sm:grid-cols-2">
          <!-- Reference Price -->
          <div class="relative" data-field="ref_price">
            <label for="{{ form.ref_price.id_for_label }}" class="mb-2 block text-sm font-medium text-gray-700 dark:text-green-200/80">Reference Price (UGX)</label>
            <div class="relative">
              {{ form.ref_price }}
            </div>
            {% if form.ref_price.errors %}<p class="mt-1 text-xs text-red-600 dark:text-red-400">{{ form.ref_price.errors.0 }}</p>{% endif %}
            <p class="mt-1 text-xs text-gray-500 dark:text-green-300/80">Baseline before bonuses/penalties.</p>
          </div>

          <!-- Moisture -->
          <div data-field="moisture">
            <label for="{{ form.moisture_content.id_for_label }}" class="mb-2 flex items-center justify-between text-sm font-medium text-gray-700 dark:text-green-200/80">
              <span>Moisture Content (%)</span>
              <span class="rounded-full bg-gray-100 dark:bg-green-900/30 px-2 py-0.5 text-[10px] font-semibold text-gray-600 dark:text-green-200/80">Typical ≤ 16.5%</span>
            </label>
            {{ form.moisture_content }}
            {% if form.moisture_content.errors %}<p class="mt-1 text-xs text-red-600 dark:text-red-400">{{ form.moisture_content.errors.0 }}</p>{% endif %}
          </div>

          <!-- Group 1 Defects -->
          <div data-field="g1">
            <label for="{{ form.group1_defects.id_for_label }}" class="mb-2 flex items-center justify-between text-sm font-medium text-gray-700 dark:text-green-200/80">
              <span>Group 1 Defects (%)</span>
              <span class="rounded-full bg-gray-100 dark:bg-green-900/30 px-2 py-0.5 text-[10px] font-semibold text-gray-600 dark:text-green-200/80">Typical ≤ 10%</span>
            </label>
            {{ form.group1_defects }}
            {% if form.group1_defects.errors %}<p class="mt-1 text-xs text-red-600 dark:text-red-400">{{ form.group1_defects.errors.0 }}</p>{% endif %}
          </div>

          <!-- Group 2 Defects -->
          <div data-field="g2">
            <label for="{{ form.group2_defects.id_for_label }}" class="mb-2 flex items-center justify-between text-sm font-medium text-gray-700 dark:text-green-200/80">
              <span>Group 2 Defects (%)</span>
              <span class="rounded-full bg-gray-100 dark:bg-green-900/30 px-2 py-0.5 text-[10px] font-semibold text-gray-600 dark:text-green-200/80">Typical ≤ 25%</span>
            </label>
            {{ form.group2_defects }}
            {% if form.group2_defects.errors %}<p class="mt-1 text-xs text-red-600 dark:text-red-400">{{ form.group2_defects.errors.0 }}</p>{% endif %}
          </div>

          <!-- Below Screen 12 -->
          <div data-field="lt12">
            <label for="{{ form.below_screen_12.id_for_label }}" class="mb-2 flex items-center justify-between text-sm font-medium text-gray-700 dark:text-green-200/80">
              <span>Below Screen 12 (%)</span>
              <span class="rounded-full bg-gray-100 dark:bg-green-900/30 px-2 py-0.5 text-[10px] font-semibold text-gray-600 dark:text-green-200/80">Typical ≤ 3%</span>
            </label>
            {{ form.below_screen_12 }}
            {% if form.below_screen_12.errors %}<p class="mt-1 text-xs text-red-600 dark:text-red-400">{{ form.below_screen_12.errors.0 }}</p>{% endif %}
          </div>

          <!-- Pods -->
          <div data-field="pods">
            <label for="{{ form.pods.id_for_label }}" class="mb-2 flex items-center justify-between text-sm font-medium text-gray-700 dark:text-green-200/80">
              <span>Pods (%)</span>
              <span class="rounded-full bg-gray-100 dark:bg-green-900/30 px-2 py-0.5 text-[10px] font-semibold text-gray-600 dark:text-green-200/80">Typical ≤ 6%</span>
            </label>
            {{ form.pods }}
            {% if form.pods.errors %}<p class="mt-1 text-xs text-red-600 dark:text-red-400">{{ form.pods.errors.0 }}</p>{% endif %}
          </div>

          <!-- Husks -->
          <div data-field="husks">
            <label for="{{ form.husks.id_for_label }}" class="mb-2 flex items-center justify-between text-sm font-medium text-gray-700 dark:text-green-200/80">
              <span>Husks (%)</span>
              <span class="rounded-full bg-gray-100 dark:bg-green-900/30 px-2 py-0.5 text-[10px] font-semibold text-gray-600 dark:text-green-200/80">Typical ≤ 6%</span>
            </label>
            {{ form.husks }}
            {% if form.husks.errors %}<p class="mt-1 text-xs text-red-600 dark:text-red-400">{{ form.husks.errors.0 }}</p>{% endif %}
          </div>

          <!-- Stones -->
          <div data-field="stones">
            <label for="{{ form.stones.id_for_label }}" class="mb-2 flex items-center justify-between text-sm font-medium text-gray-700 dark:text-green-200/80">
              <span>Stones (%)</span>
              <span class="rounded-full bg-gray-100 dark:bg-green-900/30 px-2 py-0.5 text-[10px] font-semibold text-gray-600 dark:text-green-200/80">Typical ≤ 6%</span>
            </label>
            {{ form.stones }}
            {% if form.stones.errors %}<p class="mt-1 text-xs text-red-600 dark:text-red-400">{{ form.stones.errors.0 }}</p>{% endif %}
          </div>

          <!-- Offered Price -->
          <div class="sm:col-span-2" data-field="offered_price">
            <label for="{{ form.offered_price.id_for_label }}" class="mb-2 block text-sm font-medium text-gray-700 dark:text-green-200/80">Offered Price</label>
            {{ form.offered_price }}
            {% if form.offered_price.errors %}<p class="mt-1 text-xs text-red-600 dark:text-red-400">{{ form.offered_price.errors.0 }}</p>{% endif %}
          </div>
        </div>

        <!-- Submit for small screens -->
        <div class="mt-8 border-t border-gray-100 dark:border-green-700/20 pt-6 sm:hidden">
          <button id="submitBtnSm" type="submit" class="w-full rounded-lg bg-green-700 px-4 py-3 text-sm font-medium text-white hover:bg-green-800 transition-all duration-200 shadow-md hover:shadow-lg">
            <i class="fas fa-check-circle mr-2"></i> Submit Assessment
          </button>
        </div>
      </div>

      <!-- Typical Targets (informational) -->
      <div class="mt-6 rounded-2xl border border-gray-200 dark:border-green-700/30 bg-white dark:bg-gray-900 p-4 shadow">
        <h4 class="mb-2 text-sm font-semibold text-gray-800 dark:text-green-100">Typical Targets (informational)</h4>
        <p class="text-xs text-gray-600 dark:text-green-200/70">
          Moisture ≤ 16.5 • G1 ≤ 10 • G2 ≤ 25 • &lt;Screen12 ≤ 3 • Pods ≤ 6 • Husks ≤ 6 • Stones ≤ 6 • (Pods+Husks+Stones) ≤ 6
        </p>
      </div>
    </section>

    <!-- RIGHT: Live Preview & Decision -->
    <aside class="lg:col-span-5">
      <div class="sticky top-6 space-y-6">
        <!-- Decision Card -->
        <div id="decisionCard" class="rounded-2xl border border-gray-200 dark:border-green-700/30 bg-white dark:bg-gray-900 p-6 shadow-lg">
          <div class="mb-4 flex items-center justify-between">
            <h3 class="text-lg font-medium text-gray-900 dark:text-green-50">Quality Decision (info only)</h3>
            <span id="decisionBadge" class="inline-flex items-center rounded-full px-3 py-1 text-xs font-medium uppercase tracking-wide shadow-sm"></span>
          </div>
          <ul id="reasonsList" class="list-inside list-disc space-y-1 text-sm text-gray-700 dark:text-green-100/80"></ul>
        </div>

        <!-- Metrics Card -->
        <div class="rounded-2xl border border-gray-200 dark:border-green-700/30 bg-white dark:bg-gray-900 p-6 shadow-lg">
          <div class="mb-4 flex items-center">
            <div class="flex h-8 w-8 items-center justify-center rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-200 mr-3">
              <i class="fas fa-calculator text-sm"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 dark:text-green-50">Derived Metrics</h3>
          </div>
          <dl class="grid grid-cols-1 gap-4 text-sm sm:grid-cols-2">
            <div class="rounded-xl border border-gray-200 dark:border-green-700/30 bg-gray-50 dark:bg-green-900/10 p-4">
              <dt class="text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-green-200/60">Clean Outturn (D8)</dt>
              <dd id="cleanOutturn" class="mt-1 text-lg font-semibold text-gray-900 dark:text-green-50">—</dd>
            </div>
            <div class="rounded-xl border border-gray-200 dark:border-green-700/30 bg-gray-50 dark:bg-green-900/10 p-4">
              <dt class="text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-green-200/60">Pods + Husks + Stones (B20)</dt>
              <dd id="phsSum" class="mt-1 text-lg font-semibold text-gray-900 dark:text-green-50">—</dd>
            </div>
            <div class="rounded-xl border border-gray-200 dark:border-green-700/30 bg-gray-50 dark:bg-green-900/10 p-4 sm:col-span-2">
              <dt class="text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-green-200/60">Derived Outturn (B12)</dt>
              <dd id="derivedOutturn" class="mt-1 text-lg font-semibold text-gray-900 dark:text-green-50">—</dd>
            </div>
          </dl>
        </div>

        <!-- Price Preview -->
        <div class="rounded-2xl border border-gray-200 dark:border-green-700/30 bg-white dark:bg-gray-900 p-6 shadow-lg">
          <div class="mb-4 flex items-center justify-between">
            <div class="flex items-center">
              <div class="flex h-8 w-8 items-center justify-center rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-200 mr-3">
                <i class="fas fa-coins text-sm"></i>
              </div>
              <h3 class="text-lg font-medium text-gray-900 dark:text-green-50">Price Preview</h3>
            </div>
            <span class="text-xs text-gray-500 dark:text-green-200/50">Live updates</span>
          </div>
          <div class="grid grid-cols-1 gap-4 text-sm sm:grid-cols-2">
            <div class="rounded-xl border border-gray-200 dark:border-green-700/30 bg-gray-50 dark:bg-green-900/10 p-4">
              <div class="text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-green-200/60">Reference Price</div>
              <div id="previewRefPrice" class="mt-1 text-lg font-semibold text-gray-900 dark:text-green-50">—</div>
            </div>
            <div class="rounded-xl border border-green-200 dark:border-green-700 bg-green-50 dark:bg-green-900/20 p-4">
              <div class="text-xs font-semibold uppercase tracking-wide text-green-600 dark:text-green-200">Final Price</div>
              <div id="finalPrice" class="mt-1 text-xl font-bold text-green-700 dark:text-green-50">—</div>
            </div>
          </div>
          <p id="bonusNote" class="mt-4 hidden items-center rounded-lg bg-green-50 dark:bg-green-900/20 p-3 text-xs text-green-700 dark:text-green-300">
            <i class="fas fa-gift mr-2"></i> Premium quality bonus +2,000 UGX applied
          </p>
        </div>
      </div>
    </aside>
  </form>
</div>

<!-- Live Calculation (no client-side validation; info-only) -->
<script>
  (function () {
    // Typical targets (for info display and badges only)
    const LIMITS = { moisture:16.5, g1:10, g2:25, lt12:3, pods:6, husks:6, stones:6, phs:6 };

    const q = (id) => document.getElementById(id);
    const asNum = (v) => {
      if (v === null || v === undefined) return null;
      const n = parseFloat(String(v).replace(/,/g, ''));
      return isNaN(n) ? null : n;
    };
    const clamp1 = (x) => Math.round(x * 10) / 10;
    const fmt1 = (x) => (x == null ? "—" : clamp1(x).toFixed(1));
    const z = (x) => (x == null ? 0 : x);

    // Map Django-generated IDs (default: id_<fieldname>)
    const ids = {
      ref_price: "id_ref_price",
      discretion: "id_discretion",
      moisture: "id_moisture_content",
      g1: "id_group1_defects",
      g2: "id_group2_defects",
      lt12: "id_below_screen_12",
      pods: "id_pods",
      husks: "id_husks",
      stones: "id_stones",
      fm: "id_fm"
    };

    const inputs = {};
    for (const k in ids) inputs[k] = q(ids[k]);

    const cleanOutturnEl = q("cleanOutturn");
    const phsSumEl = q("phsSum");
    const derivedOutturnEl = q("derivedOutturn");
    const decisionBadge = q("decisionBadge");
    const reasonsList = q("reasonsList");
    const finalPriceEl = q("finalPrice");
    const refPriceEl = q("previewRefPrice");
    const bonusNote = q("bonusNote");

    // Do NOT set min/max/required; keep inputs free
    // Only helpful numeric hints
    ["moisture","g1","g2","lt12","pods","husks","stones","ref_price","discretion","offered_price"].forEach(k=>{
      const el = inputs[k];
      if (el) {
        el.setAttribute("inputmode","decimal");
        el.setAttribute("step","any");
      }
    });

    const val = (el) => (el ? asNum(el.value) : null);

    function compute() {
      const RP = val(inputs.ref_price);
      const disc = val(inputs.discretion);

      const B4 = val(inputs.moisture);
      const B6 = val(inputs.g1);
      const B8 = val(inputs.g2);
      const B10 = val(inputs.lt12);
      const B14 = val(inputs.pods);
      const B16 = val(inputs.husks);
      const B18 = val(inputs.stones);

      // Reference price preview
      refPriceEl.textContent = (RP != null) ? Math.round(RP).toLocaleString('en-UG') : "—";

      // Clean outturn
      let cleanOutturn = null;
      if ([B6,B8,B14,B16,B18,B10].every(x => x != null)) {
        cleanOutturn = 100 - z(B6) - z(B8) - z(B14) - z(B16) - z(B18) - z(B10);
        cleanOutturnEl.textContent = fmt1(cleanOutturn) + " %";
      } else {
        cleanOutturnEl.textContent = "—";
      }

      // P+H+S (also mirror into fm if present)
      let phsSum = null;
      if ([B14,B16,B18].every(x => x != null)) {
        phsSum = z(B14) + z(B16) + z(B18);
        phsSumEl.textContent = fmt1(phsSum) + " %";
        if (inputs.fm) inputs.fm.value = clamp1(phsSum).toFixed(1);
      } else {
        phsSumEl.textContent = "—";
      }

      // Derived Outturn (aligned with modal: NO hard reject on <12 > 3)
      let B12 = null;
      if ([B4,B6,B8,B14,B16,B18,B10].every(x => x != null)) {
        let outturn = 100
                      - Math.max(0, z(B4) - 14)
                      - Math.max(0, z(B6) - 4)
                      - Math.max(0, z(B8) - 10)
                      - z(B14)
                      - z(B16)
                      - z(B18)
                      - Math.max(0, z(B10) - 1);
        B12 = clamp1(outturn);
        derivedOutturnEl.textContent = fmt1(B12) + " %";
      } else {
        derivedOutturnEl.textContent = "—";
      }

      // Informational “decision”
      reasonsList.innerHTML = "";
      const missing = [B4,B6,B8,B14,B16,B18,B10].some(x => x == null);
      const reasons = [];
      if (!missing) {
        if (z(B4)  > LIMITS.moisture) reasons.push(`Moisture ${fmt1(B4)}% > ${LIMITS.moisture}%`);
        if (z(B6)  > LIMITS.g1)       reasons.push(`Group 1 defects ${fmt1(B6)}% > ${LIMITS.g1}%`);
        if (z(B8)  > LIMITS.g2)       reasons.push(`Group 2 defects ${fmt1(B8)}% > ${LIMITS.g2}%`);
        if (z(B10) > LIMITS.lt12)     reasons.push(`Below screen 12 ${fmt1(B10)}% > ${LIMITS.lt12}%`);
        if (z(B14) > LIMITS.pods)     reasons.push(`Pods ${fmt1(B14)}% > ${LIMITS.pods}%`);
        if (z(B16) > LIMITS.husks)    reasons.push(`Husks ${fmt1(B16)}% > ${LIMITS.husks}%`);
        if (z(B18) > LIMITS.stones)   reasons.push(`Stones ${fmt1(B18)}% > ${LIMITS.stones}%`);
        if (phsSum != null && phsSum > LIMITS.phs) reasons.push(`Pods+Husks+Stones ${fmt1(phsSum)}% > ${LIMITS.phs}%`);
      }

      if (missing) {
        decisionBadge.textContent = "Pending";
        decisionBadge.className = "inline-flex items-center rounded-full bg-gray-100 dark:bg-green-900/30 text-gray-800 dark:text-green-200 px-3 py-1 text-xs font-medium uppercase tracking-wide shadow-sm";
        const li = document.createElement('li');
        li.textContent = "Provide inputs to see thresholds and price preview.";
        li.className = 'text-gray-600 dark:text-green-200/70';
        reasonsList.appendChild(li);
      } else if (reasons.length) {
        decisionBadge.textContent = "Above targets";
        decisionBadge.className = "inline-flex items-center rounded-full bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-200 px-3 py-1 text-xs font-medium uppercase tracking-wide shadow-sm";
        reasons.forEach(r => {
          const li = document.createElement('li');
          li.textContent = r;
          li.className = 'text-amber-700 dark:text-amber-300';
          reasonsList.appendChild(li);
        });
      } else {
        decisionBadge.textContent = "Within targets";
        decisionBadge.className = "inline-flex items-center rounded-full bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200 px-3 py-1 text-xs font-medium uppercase tracking-wide shadow-sm";
        const li = document.createElement('li');
        li.textContent = "Metrics are within typical targets (info only).";
        li.className = 'text-green-700 dark:text-green-300';
        reasonsList.appendChild(li);
      }

      // Price preview (no blocking)
      bonusNote.classList.add("hidden");
      if (RP == null || B12 == null || [B4,B6,B8,B10,B14,B16,B18].some(x => x == null)) {
        finalPriceEl.textContent = "—";
        return;
      }

      let price = RP;

      // Bonus +2000
      const bonus = (z(B6) <= 1 && z(B8) <= 5 && z(B4) <= 13 && B12 >= 80
                     && z(B14) === 0 && z(B16) === 0 && z(B18) === 0 && z(B10) <= 1);
      if (bonus) {
        price += 2000;
        bonusNote.classList.remove("hidden");
      }

      // Moisture penalty (>=14)
      if (z(B4) >= 14) price -= (z(B4) - 14) * RP * 0.002;

      // G1 penalty over 4
      if (z(B6) > 4) price -= (z(B6) - 4) * 50;

      // G2 penalty over 10
      if (z(B8) > 10) price -= (z(B8) - 10) * 20;

      // Derived outturn adjustments
      if (B12 < 78) price -= (78 - B12) * 50;
      else if (B12 > 82) price += (B12 - 82) * 50;

      // Pods/Husks/Stones deductions
      price -= z(B14) * 10 + z(B16) * 10 + z(B18) * 20;

      // Below screen 12 > 1 penalty
      if (z(B10) > 1) price -= (z(B10) - 1) * 30;

      // Discretion
      if (!Number.isNaN(disc) && disc != null) price += disc;

      price = Math.max(0, clamp1(price));
      finalPriceEl.textContent = price.toLocaleString('en-UG', {minimumFractionDigits: 1, maximumFractionDigits: 1});
    }

    // Debounced live compute
    let t = null;
    function schedule(){ if(t) cancelAnimationFrame(t); t = requestAnimationFrame(compute); }

    // Attach listeners (no submit guards)
    Object.values(inputs).forEach(el => {
      if (!el) return;
      el.addEventListener("input", schedule);
      el.addEventListener("change", schedule);
    });

    // Initial compute after paint (fields stay empty)
    window.addEventListener("DOMContentLoaded", () => requestAnimationFrame(compute));
  })();
</script>
{% endblock %}
