{% extends 'base.html' %}
{% load static %}

{% block title %}Coffee Suppliers - GreatPearl Coffee{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@1.5.2/dist/select2-bootstrap4.min.css" rel="stylesheet">
<style>
  .select2-container--bootstrap4 .select2-selection--single{height:42px;padding:.5rem;border:1px solid #d1d5db;border-radius:.5rem}
  .select2-container--bootstrap4 .select2-selection--single .select2-selection__arrow{height:40px}
  .select2-container--bootstrap4 .select2-dropdown{border:1px solid #d1d5db;border-radius:.5rem}
  .select2-container--bootstrap4 .select2-results__option--highlighted{background-color:#2563eb!important}
  .supplier-row{transition:all .2s}
  .supplier-row:hover{background-color:#f9fafb}
  .dark .supplier-row:hover{background-color:#374151}
  .badge{font-size:.75rem;padding:.25rem .5rem;border-radius:.375rem;display:inline-flex;align-items:center;gap:.25rem}
</style>
{% endblock %}

{% block page_title %}Coffee Suppliers Management{% endblock %}

{% block header_actions %}
<button type="button" onclick="openSupplierModal()" class="inline-flex items-center px-4 py-2 bg-primary-600 dark:bg-primary-700 text-white text-sm font-medium rounded-lg hover:bg-primary-700 dark:hover:bg-primary-600 transition-colors shadow-md hover:shadow-lg">
  <i class="fas fa-plus mr-2"></i> Add Supplier
</button>
{% endblock %}

{% block content %}

<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden mb-8">
  <!-- Search & actions -->
  <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <form method="get" class="flex items-center gap-3 w-full sm:w-auto">
      <div class="relative w-full sm:w-72">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <i class="fas fa-search text-gray-400"></i>
        </div>
        <input
          id="supplier-search"
          name="q"
          type="text"
          value="{{ q|default:'' }}"
          placeholder="Search suppliers..."
          class="pl-10 w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400">
      </div>

      <select name="per_page" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
        {% for n in per_page_options %}
          <option value="{{ n }}" {% if per_page == n %}selected{% endif %}>{{ n }} / page</option>
        {% endfor %}
      </select>

      <button type="submit" class="inline-flex items-center px-4 py-2 bg-primary-600 dark:bg-primary-700 text-white text-sm font-medium rounded-lg hover:bg-primary-700 dark:hover:bg-primary-600">
        Apply
      </button>
    </form>

    <div class="text-sm text-gray-500 dark:text-gray-400">
      Total: {{ suppliers.paginator.count }}
    </div>
  </div>

  <!-- Table -->
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
      <thead class="bg-gray-50 dark:bg-gray-700">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">Supplier</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">Contact</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">Coffee Types</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider hidden md:table-cell">Last Supply</th>
          <th class="px-6 py-3 text-right text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">Actions</th>
        </tr>
      </thead>
      <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
        {% for supplier in suppliers %}
        <tr class="supplier-row">
          <td class="px-6 py-4">
            <div class="flex items-center">
              <div class="h-10 w-10 rounded-full bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center">
                <i class="fas fa-truck text-primary-600 dark:text-primary-400"></i>
              </div>
              <div class="ml-4">
                <div class="text-sm font-semibold text-gray-900 dark:text-white">{{ supplier.name }}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">ID: {{ supplier.id }}</div>
              </div>
            </div>
          </td>

          <td class="px-6 py-4">
            <div class="text-sm text-gray-900 dark:text-white">{{ supplier.phone }}</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">{{ supplier.email|default:"No email" }}</div>
          </td>

          <td class="px-6 py-4">
            <div class="flex flex-wrap gap-1">
              {% if supplier.coffee_types %}
                {% for t in supplier.coffee_types %}
                  <span class="badge bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300">{{ t }}</span>
                {% endfor %}
              {% else %}
                <span class="text-xs text-gray-400 italic">No assessed purchases</span>
              {% endif %}
            </div>
          </td>

          <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400 hidden md:table-cell">
            {% if supplier.last_supply %}
              {{ supplier.last_supply|date:"M d, Y" }}
            {% else %}
              <span class="text-gray-400 dark:text-gray-500 italic">Never</span>
            {% endif %}
          </td>

          <td class="px-6 py-4 text-right">
            <div class="inline-flex gap-2">
              <a href="#" class="px-3 py-2 rounded-md text-primary-600 dark:text-primary-400 hover:bg-primary-50 dark:hover:bg-primary-900/30">
                <i class="fas fa-eye mr-1"></i><span class="hidden sm:inline">View</span>
              </a>
              <button type="button" onclick="openSupplierModal('{{ supplier.id|escapejs }}','{{ supplier.name|escapejs }}','{{ supplier.phone|escapejs }}','{{ supplier.email|default_if_none:''|escapejs }}','{{ supplier.address|default_if_none:''|escapejs }}')"
                class="px-3 py-2 rounded-md text-yellow-600 dark:text-yellow-400 hover:bg-yellow-50 dark:hover:bg-yellow-900/30">
                <i class="fas fa-edit mr-1"></i><span class="hidden sm:inline">Edit</span>
              </button>
              <button type="button" onclick="openPurchaseModal('{{ supplier.id|escapejs }}','{{ supplier.name|escapejs }}')"
                class="px-3 py-2 rounded-md text-green-600 dark:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/30">
                <i class="fas fa-plus-circle mr-1"></i><span class="hidden sm:inline">Purchase</span>
              </button>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="px-6 py-8 text-center">
            <div class="text-gray-500 dark:text-gray-400 py-8">
              <div class="w-16 h-16 mx-auto bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mb-4">
                <i class="fas fa-truck text-2xl text-gray-400 dark:text-gray-500"></i>
              </div>
              <p class="text-sm font-medium mb-2">No suppliers found</p>
              <p class="text-xs mb-4">Get started by adding your first coffee supplier</p>
              <button type="button" onclick="openSupplierModal()" class="inline-flex items-center px-4 py-2 bg-primary-600 dark:bg-primary-700 text-white text-sm font-medium rounded-lg hover:bg-primary-700 dark:hover:bg-primary-600 transition-colors shadow-md hover:shadow-lg">
                <i class="fas fa-plus mr-2"></i> Add Your First Supplier
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if suppliers.has_other_pages %}
  <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex items-center justify-between">
    <div class="text-sm text-gray-700 dark:text-gray-400">
      Showing {{ suppliers.start_index }} to {{ suppliers.end_index }} of {{ suppliers.paginator.count }} entries
    </div>
    <div class="flex gap-2">
      {% if suppliers.has_previous %}
        <a href="?page={{ suppliers.previous_page_number }}&q={{ q|urlencode }}&per_page={{ per_page }}" class="px-3 py-1 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">Previous</a>
      {% endif %}
      {% for i in suppliers.paginator.page_range %}
        {% if suppliers.number == i %}
          <span class="px-3 py-1 rounded-lg bg-primary-600 text-white">{{ i }}</span>
        {% else %}
          <a href="?page={{ i }}&q={{ q|urlencode }}&per_page={{ per_page }}" class="px-3 py-1 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">{{ i }}</a>
        {% endif %}
      {% endfor %}
      {% if suppliers.has_next %}
        <a href="?page={{ suppliers.next_page_number }}&q={{ q|urlencode }}&per_page={{ per_page }}" class="px-3 py-1 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">Next</a>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>

<!-- Overlay -->
<div id="modalOverlay" class="fixed inset-0 bg-black/50 dark:bg-black/70 z-40 hidden"></div>

<!-- Supplier Modal -->
<div id="supplierModal" class="fixed inset-0 z-50 hidden p-4">
  <div class="mx-auto max-w-md">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 id="supplierFormTitle" class="text-xl font-semibold text-gray-900 dark:text-white">Add New Supplier</h2>
          <button type="button" onclick="closeSupplierModal()" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
            <i class="fas fa-times text-lg"></i>
          </button>
        </div>
        <form method="post" id="supplierForm" class="space-y-4" action="{% url 'supplier_list' %}?q={{ q|urlencode }}&per_page={{ per_page }}">
          {% csrf_token %}
          <input type="hidden" name="supplier_id" id="supplier_id" value="">
          <div>
            <label for="id_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Supplier Name*</label>
            <input id="id_name" name="name" type="text" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
          </div>
          <div>
            <label for="id_phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Phone*</label>
            <input id="id_phone" name="phone" type="text" required placeholder="+256XXXXXXXXX" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
          </div>
          <div>
            <label for="id_email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email</label>
            <input id="id_email" name="email" type="email" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
          </div>
          <div>
            <label for="id_address" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Address</label>
            <textarea id="id_address" name="address" rows="3" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></textarea>
          </div>
          <div class="mt-6 flex justify-end gap-3">
            <button type="button" onclick="closeSupplierModal()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-primary-600 dark:bg-primary-700 text-white text-sm font-medium rounded-lg hover:bg-primary-700 dark:hover:bg-primary-600">Save Supplier</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Purchase Modal -->
<div id="purchaseModal" class="fixed inset-0 z-50 hidden p-4">
  <div class="mx-auto max-w-md">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 id="purchaseFormTitle" class="text-xl font-semibold text-gray-900 dark:text-white">Add Coffee Purchase</h2>
          <button type="button" onclick="closePurchaseModal()" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
            <i class="fas fa-times text-lg"></i>
          </button>
        </div>
        <form method="post" id="purchaseForm" action="{% url 'supplier_list' %}?q={{ q|urlencode }}&per_page={{ per_page }}" class="space-y-4">
          {% csrf_token %}
          <input type="hidden" name="supplier_id" id="purchase_supplier_id" value="">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Supplier</label>
            <p id="purchase_supplier_name" class="text-base font-medium text-primary-600 dark:text-primary-400"></p>
          </div>
          <div>
            <label for="id_coffee_category" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Coffee Form*</label>
            <select id="id_coffee_category" name="coffee_category" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
              <option value="">Select coffee form</option>
              <option value="GR">Green Coffee</option>
              <option value="PA">Parchment Coffee</option>
              <option value="KB">Kiboko Coffee</option>
            </select>
          </div>
          <div>
            <label for="id_coffee_type" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Coffee Type*</label>
            <select id="id_coffee_type" name="coffee_type" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
              <option value="AR" selected>Arabica</option>
              <option value="RB">Robusta</option>
            </select>
          </div>
          <div>
            <label for="id_quantity" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Quantity (kg)*</label>
            <input id="id_quantity" name="quantity" type="number" min="1" step="1" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="Weight in kilograms">
          </div>
          <div>
            <label for="id_bags" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Bags</label>
            <input id="id_bags" name="bags" type="number" min="0" value="0" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
          </div>
          <div>
            <label for="id_notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Notes</label>
            <textarea id="id_notes" name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></textarea>
          </div>
          <div class="mt-6 flex justify-end gap-3">
            <button type="button" onclick="closePurchaseModal()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-primary-600 dark:bg-primary-700 text-white text-sm font-medium rounded-lg hover:bg-primary-700 dark:hover:bg-primary-600">Record Purchase</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
  // Enhance only the modals' selects
  document.addEventListener('DOMContentLoaded', function () {
    const selects = document.querySelectorAll('#supplierModal select, #purchaseModal select');
    selects.forEach(s => $(s).select2({ theme: 'bootstrap4', width: '100%' }));
  });

  // Overlay handling
  const overlay = document.getElementById('modalOverlay');
  function showOverlay(){ overlay.classList.remove('hidden'); }
  function hideOverlay(){ overlay.classList.add('hidden'); }

  // Supplier modal
  function openSupplierModal(id='', name='', phone='', email='', address=''){
    document.getElementById('supplier_id').value = id || '';
    document.getElementById('id_name').value = name || '';
    document.getElementById('id_phone').value = phone || '';
    document.getElementById('id_email').value = email || '';
    document.getElementById('id_address').value = address || '';
    document.getElementById('supplierFormTitle').textContent = id ? 'Edit Supplier' : 'Add New Supplier';
    document.getElementById('supplierModal').classList.remove('hidden');
    showOverlay();
    setTimeout(()=>document.getElementById('id_name').focus(),0);
  }
  function closeSupplierModal(){
    document.getElementById('supplierModal').classList.add('hidden');
    hideOverlay();
  }

  // Purchase modal
  function openPurchaseModal(supplierId, supplierName){
    document.getElementById('purchase_supplier_id').value = supplierId;
    document.getElementById('purchase_supplier_name').textContent = supplierName;
    document.getElementById('id_coffee_category').value = '';
    document.getElementById('id_coffee_type').value = 'AR';
    document.getElementById('id_quantity').value = '';
    document.getElementById('id_bags').value = '0';
    document.getElementById('id_notes').value = '';
    document.getElementById('purchaseFormTitle').textContent = `Add Purchase - ${supplierName}`;
    document.getElementById('purchaseModal').classList.remove('hidden');
    showOverlay();
    setTimeout(()=>document.getElementById('id_coffee_category').focus(),0);
  }
  function closePurchaseModal(){
    document.getElementById('purchaseModal').classList.add('hidden');
    hideOverlay();
  }

  // Close on overlay click
  overlay.addEventListener('click', () => {
    closeSupplierModal();
    closePurchaseModal();
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', function(e){
    if (e.ctrlKey && e.shiftKey && e.key === 'S'){ e.preventDefault(); openSupplierModal(); }
    if (e.key === 'Escape'){ closeSupplierModal(); closePurchaseModal(); }
  });
</script>
{% endblock %}
