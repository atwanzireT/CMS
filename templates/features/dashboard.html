{% load humanize %}

<!-- Dashboard Shell -->
<div x-data="dashboard()" x-init="init()" @keydown.escape.window="showNotif=false">

  <!-- Dark mode toggle (fixed) -->
  <button id="darkModeToggle"
          @click="toggleDark()"
          class="fixed bottom-6 right-6 z-50 w-12 h-12 rounded-full bg-white dark:bg-gray-800 shadow-lg flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-primary-500 border border-gray-200 dark:border-gray-700 transition-colors duration-300">
    <!-- moon (light theme icon) -->
    <svg x-show="!darkMode" class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
    </svg>
    <!-- sun (dark theme icon) -->
    <svg x-show="darkMode" class="w-6 h-6 text-yellow-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
    </svg>
  </button>


    <!-- Notification panel -->
    <div id="notif-panel"
         x-show="showNotif"
         x-transition.opacity
         @click.outside="showNotif=false"
         class="mt-2 w-80 bg-white dark:bg-gray-900 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 absolute right-0 z-50"
         role="dialog" aria-modal="true">
      <div class="p-4 border-b border-gray-200 dark:border-gray-700">
        <h3 class="font-semibold text-gray-900 dark:text-white">Notifications</h3>
      </div>
      <div class="max-h-96 overflow-y-auto">
        {% if pending_milling > 0 %}
        <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex items-start">
          <div class="flex-shrink-0 pt-0.5">
            <div class="w-3 h-3 bg-amber-500 rounded-full"></div>
          </div>
          <div class="ml-3">
            <p class="text-sm font-medium text-gray-900 dark:text-white">
              {{ pending_milling }} pending milling process{{ pending_milling|pluralize:"es" }}
            </p>
            <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">Require your attention</p>
          </div>
        </div>
        {% endif %}

        {% if recent_transactions %}
        <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex items-start">
          <div class="flex-shrink-0 pt-0.5">
            <div class="w-3 h-3 bg-primary-500 rounded-full"></div>
          </div>
          <div class="ml-3">
            <p class="text-sm font-medium text-gray-900 dark:text-white">
              {{ recent_transactions|length }} new transaction{{ recent_transactions|pluralize }}
            </p>
            <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">Recently recorded</p>
          </div>
        </div>
        {% endif %}

        {% if not pending_milling and not recent_transactions %}
        <div class="p-4 text-center text-gray-600 dark:text-gray-400">
          <p>No new notifications</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- PAGE BODY -->
  <div class="p-6 max-w-[1400px] mx-auto">

    <!-- Header with user info -->
    <div class="mb-8 flex justify-between items-center">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Coffee Business Dashboard</h1>
        <p class="text-gray-600 dark:text-gray-400">
          Welcome back, {{ user.first_name|default:user.username }}! Here's your overview.
        </p>
      </div>
      <div class="flex items-center space-x-4">
        <span class="text-sm text-gray-600 dark:text-gray-400">{{ timezone.now|date:"l, F j, Y" }}</span>
        <div class="h-10 w-10 rounded-full bg-primary-100 dark:bg-primary-900/40 flex items-center justify-center text-primary-700 dark:text-primary-300 font-medium shadow-inner">
          {{ user.first_name|first|default:user.username|first|upper }}
        </div>
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- Customers -->
      <div class="bg-white dark:bg-gray-900 rounded-xl shadow-sm p-6 border-l-4 border-primary-500">
        <div class="flex items-center">
          <div class="p-3 rounded-xl bg-primary-100 dark:bg-primary-900/40 text-primary-600 dark:text-primary-400 shadow-inner">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
            </svg>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Customers</p>
            <p class="text-sm font-semibold text-gray-900 dark:text-white">{{ total_customers|intcomma }}</p>
            <p class="text-xs text-primary-600 dark:text-primary-400 mt-1">
              <span class="inline-flex items-center">
                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
                </svg>
                {{ new_customers_week }} new this week
              </span>
            </p>
          </div>
        </div>
      </div>

      <!-- Milling -->
      <div class="bg-white dark:bg-gray-900 rounded-xl shadow-sm p-6 border-l-4 border-amber-500">
        <div class="flex items-center">
          <div class="p-3 rounded-xl bg-amber-100 dark:bg-amber-900/40 text-amber-600 dark:text-amber-400 shadow-inner">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Coffee Milling</p>
            <p class="text-sm font-semibold text-gray-900 dark:text-white">{{ total_hulled|floatformat:2|intcomma }} kg</p>
          </div>
        </div>
        <div class="flex space-x-2 mt-3">
          <span class="text-xs bg-primary-100 dark:bg-primary-900/40 text-primary-800 dark:text-primary-300 px-2 py-1 rounded-full">
            {{ completed_milling }} completed
          </span>
          <span class="text-xs bg-amber-100 dark:bg-amber-900/40 text-amber-800 dark:text-amber-300 px-2 py-1 rounded-full">
            {{ pending_milling }} pending
          </span>
        </div>
      </div>

      <!-- Financial -->
      <div class="bg-white dark:bg-gray-900 rounded-xl shadow-sm p-6 border-l-4 border-green-500">
        <div class="flex items-center">
          <div class="p-3 rounded-xl bg-green-100 dark:bg-green-900/40 text-green-600 dark:text-green-400 shadow-inner">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
            </svg>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Net Balance</p>
            <p class="text-sm font-semibold {% if total_revenue > total_debits %}text-green-600{% else %}text-red-600{% endif %}">
              Ush {{ total_revenue|floatformat:2|intcomma }}
            </p>
          </div>
        </div>
        <div class="flex space-x-2 mt-3">
          <span class="text-xs bg-green-100 dark:bg-green-900/40 text-green-800 dark:text-green-300 px-2 py-1 rounded-full">
            +Ush {{ total_revenue|floatformat:2|intcomma }}
          </span>
          <span class="text-xs bg-red-100 dark:bg-red-900/40 text-red-800 dark:text-red-300 px-2 py-1 rounded-full">
            -Ush {{ total_debits|floatformat:2|intcomma }}
          </span>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="bg-white dark:bg-gray-900 rounded-xl shadow-sm p-6 border-l-4 border-amber-400">
        <div class="flex items-center mb-4">
          <div class="p-3 rounded-xl bg-amber-100 dark:bg-amber-900/40 text-amber-600 dark:text-amber-400 shadow-inner">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
            </svg>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Quick Actions</p>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <a href="#" class="text-xs bg-primary-100 dark:bg-primary-900/40 hover:bg-primary-200 dark:hover:bg-primary-800 text-primary-800 dark:text-primary-300 px-2 py-2 rounded text-center transition-colors">New Customer</a>
          <a href="#" class="text-xs bg-amber-100 dark:bg-amber-900/40 hover:bg-amber-200 dark:hover:bg-amber-800 text-amber-800 dark:text-amber-300 px-2 py-2 rounded text-center transition-colors">New Milling</a>
          <a href="#" class="text-xs bg-green-100 dark:bg-green-900/40 hover:bg-green-200 dark:hover:bg-green-800 text-green-800 dark:text-green-300 px-2 py-2 rounded text-center transition-colors">Record Sale</a>
          <a href="#" class="text-xs bg-amber-100 dark:bg-amber-900/40 hover:bg-amber-200 dark:hover:bg-amber-800 text-amber-800 dark:text-amber-300 px-2 py-2 rounded text-center transition-colors">Record Purchase</a>
        </div>
      </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <div class="bg-white dark:bg-gray-900 rounded-xl shadow-sm p-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Revenue vs Expenses</h3>
        <div class="chart-container">
          <canvas id="revenueExpensesChart"></canvas>
        </div>
      </div>
      <div class="bg-white dark:bg-gray-900 rounded-xl shadow-sm p-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Coffee Types Distribution</h3>
        <div class="chart-container">
          <canvas id="coffeeTypesChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Tables -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
      <!-- Recent Transactions -->
      <div class="bg-white dark:bg-gray-900 rounded-xl shadow-sm overflow-hidden lg:col-span-2">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gradient-to-r from-primary-50 to-teal-50 dark:from-gray-900 dark:to-gray-800">
          <div>
            <h3 class="text-lg font-semibold text-teal-800 dark:text-primary-200">Recent Milling Transactions</h3>
            <p class="text-sm text-teal-700 dark:text-primary-300">Latest financial activities</p>
          </div>
          <a href="#" class="text-xs text-teal-700 dark:text-primary-300 hover:underline">View all</a>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50 dark:bg-gray-800">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">Date</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">Customer</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">Type</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">Amount</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
              {% for transaction in recent_transactions|slice:":5" %}
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/60">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">
                  {{ transaction.created_at|date:"M j, Y" }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                  {{ transaction.account.customer.name }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="px-2 py-1 text-xs font-medium
                               {% if transaction.transaction_type == 'C' %}bg-primary-100 dark:bg-primary-900/40 text-primary-800 dark:text-primary-300
                               {% else %}bg-red-100 dark:bg-red-900/40 text-red-800 dark:text-red-300{% endif %} rounded-full">
                    {{ transaction.get_transaction_type_display }}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900 dark:text-white">
                  Ush {{ transaction.amount|floatformat:2|intcomma }}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-600 dark:text-gray-400">No transactions found</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Top Customers -->
      <div class="bg-white dark:bg-gray-900 rounded-xl shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gradient-to-r from-primary-50 to-teal-50 dark:from-gray-900 dark:to-gray-800">
          <div>
            <h3 class="text-lg font-semibold text-teal-800 dark:text-primary-200">Top Customers</h3>
            <p class="text-sm text-teal-700 dark:text-primary-300">By milling volume</p>
          </div>
          <a href="#" class="text-xs text-teal-700 dark:text-primary-300 hover:underline">View all</a>
        </div>
        <div class="p-6">
          <ul class="divide-y divide-gray-200 dark:divide-gray-700">
            {% for customer in top_customers|slice:":5" %}
            <li class="py-4">
              <div class="flex items-center space-x-4">
                <div class="flex-shrink-0">
                  <div class="h-12 w-12 rounded-full bg-primary-100 dark:bg-primary-900/40 flex items-center justify-center text-primary-700 dark:text-primary-300 font-medium shadow-inner">
                    {{ customer.name|first|upper }}
                  </div>
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-semibold text-gray-900 dark:text-white truncate">{{ customer.name }}</p>
                  <p class="text-xs text-gray-600 dark:text-gray-400 truncate">ID: {{ customer.id }}</p>
                </div>
                <div class="text-right">
                  <p class="text-sm font-bold text-gray-900 dark:text-white">{{ customer.milling_volume|floatformat:2|intcomma }} kg</p>
                  <p class="text-xs text-gray-600 dark:text-gray-400">milled</p>
                </div>
              </div>
            </li>
            {% empty %}
            <li class="py-4 text-center text-sm text-gray-600 dark:text-gray-400">No customer data available</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>

    <!-- Second Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Recent Sales -->
      <div class="bg-white dark:bg-gray-900 rounded-xl shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gradient-to-r from-primary-50 to-teal-50 dark:from-gray-900 dark:to-gray-800">
          <div>
            <h3 class="text-lg font-semibold text-teal-800 dark:text-primary-200">Recent Coffee Sales</h3>
            <p class="text-sm text-teal-700 dark:text-primary-300">Latest product sales</p>
          </div>
          <a href="#" class="text-xs text-teal-700 dark:text-primary-300 hover:underline">View all</a>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50 dark:bg-gray-800">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">Date</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">Type</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">Quantity</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">Amount</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
              {% for sale in recent_sales|slice:":5" %}
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/60">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">
                  {{ sale.sale_date|date:"M j, Y" }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                  {{ sale.get_coffee_type_display }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">
                  {{ sale.quantity|floatformat:2|intcomma }} kg
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900 dark:text-white">
                  Ush {{ sale.total_amount|floatformat:2|intcomma }}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-600 dark:text-gray-400">No sales records found</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Business Summary -->
      <div class="bg-white dark:bg-gray-900 rounded-xl shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Business Summary</h3>
          <p class="text-sm text-gray-600 dark:text-gray-400">Key performance metrics</p>
        </div>
        <div class="p-6">
          <dl class="grid grid-cols-1 gap-5 sm:grid-cols-2">
            <div class="px-4 py-5 bg-primary-50 dark:bg-primary-900/30 rounded-lg overflow-hidden">
              <dt class="text-sm font-medium text-primary-700 dark:text-primary-300 truncate">Total Milling Volume</dt>
              <dd class="mt-1 text-2xl font-bold text-gray-900 dark:text-white">{{ total_hulled|floatformat:2|intcomma }} kg</dd>
            </div>
            <div class="px-4 py-5 bg-primary-50 dark:bg-primary-900/30 rounded-lg overflow-hidden">
              <dt class="text-sm font-medium text-primary-700 dark:text-primary-300 truncate">Total Revenue</dt>
              <dd class="mt-1 text-2xl font-bold text-gray-900 dark:text-white">Ush {{ total_revenue|floatformat:2|intcomma }}</dd>
            </div>
            <div class="px-4 py-5 bg-primary-50 dark:bg-primary-900/30 rounded-lg overflow-hidden">
              <dt class="text-sm font-medium text-primary-700 dark:text-primary-300 truncate">Avg Milling Rate</dt>
              <dd class="mt-1 text-2xl font-bold text-gray-900 dark:text-white">Ush 150.00/kg</dd>
            </div>
            <div class="px-4 py-5 bg-primary-50 dark:bg-primary-900/30 rounded-lg overflow-hidden">
              <dt class="text-sm font-medium text-primary-700 dark:text-primary-300 truncate">Customer Growth</dt>
              <dd class="mt-1 text-2xl font-bold text-gray-900 dark:text-white">+{{ new_customers_week }} this week</dd>
            </div>
          </dl>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Tiny helper styles (badge) -->
<style>
  .notification-badge{
    @apply absolute -top-1 -right-1 min-w-[1.25rem] h-5 px-1 bg-red-500 text-white text-xs rounded-full flex items-center justify-center;
  }
</style>

<!-- Alpine component for this page -->
<script>
  function dashboard(){
    return {
      darkMode: false,
      showNotif: false,
      init(){
        // initial dark mode from localStorage or system
        const saved = localStorage.getItem('darkMode');
        this.darkMode = saved ? saved === 'true' : window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.classList.toggle('dark', this.darkMode);
      },
      toggleDark(){
        this.darkMode = !this.darkMode;
        document.documentElement.classList.toggle('dark', this.darkMode);
        localStorage.setItem('darkMode', this.darkMode ? 'true' : 'false');
      }
    }
  }
</script>
