{% load static %}

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50:'#ecfdf5',100:'#d1fae5',200:'#a7f3d0',300:'#6ee7b7',
              400:'#34d399',500:'#10b981',600:'#059669',700:'#047857',
              800:'#065f46',900:'#064e3b',
            },
          },
          boxShadow: {
            soft: '0 12px 30px -14px rgba(16,185,129,0.25), 0 8px 16px -8px rgba(16,185,129,0.2)',
          },
          backdropBlur: { xs: '2px' }
        }
      }
    }
  </script>

  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    html, body { font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial; }
    .glass { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    .glass-light { background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.6)); }
    .glass-dark  { background: linear-gradient(180deg, rgba(6,95,70,.35), rgba(6,78,59,.22)); border: 1px solid rgba(16,185,129,.25); }
    .skeleton { position:relative; overflow:hidden; background:rgba(15,23,42,.06); }
    .dark .skeleton { background: rgba(148,163,184,.12); }
    .skeleton:after { content:""; position:absolute; inset:0; transform:translateX(-100%); background:linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent); animation: shimmer 1.2s infinite; }
    .dark .skeleton:after { background: linear-gradient(90deg, transparent, rgba(148,163,184,.25), transparent); }
    @keyframes shimmer { 100% { transform: translateX(100%); } }
  </style>
</head>

<body class="h-full bg-gradient-to-b from-primary-50/70 to-white dark:from-slate-950 dark:to-slate-900 text-slate-900 dark:text-slate-100">
  <!-- Top bar -->
  <header class="sticky top-0 z-30 border-b border-primary-100/60 dark:border-slate-800 bg-white/70 dark:bg-slate-900/70 backdrop-blur">
    <div class="mx-auto px-4 lg:px-6 py-3 flex items-center gap-3">
      <div class="flex items-center gap-2">
        <div class="h-9 w-9 rounded-xl bg-primary-500 flex items-center justify-center shadow-soft">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h18M5 7l1.5 12h11L19 7M8 7V5a4 4 0 118 0v2" />
          </svg>
        </div>
        <div class="font-semibold tracking-tight">Great Pearl Dashboard</div>
      </div>

      <div class="ml-auto flex items-center gap-3">
        <a href="{% url 'store:home' %}"
           class="hidden sm:inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-primary-600 text-white hover:bg-primary-700 shadow-soft">
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M11 5h10M11 9h10M11 13h10M5 7h.01M5 11h.01M5 15h.01" />
          </svg>
          <span class="text-sm font-semibold">Quick Actions</span>
        </a>
      </div>
    </div>
  </header>

  <!-- Greeting / Quick Links -->
  <section class="mx-auto px-4 lg:px-6 mt-6">
    <div class="rounded-2xl glass shadow-soft border border-white/50 dark:border-transparent p-6 md:p-8 glass-light dark:glass-dark">
      <div class="flex flex-col md:flex-row items-start md:items-center gap-6">
        <div class="flex-1">
          <p id="greeting" class="text-2xl md:text-3xl font-extrabold text-primary-700 dark:text-primary-300"></p>
          <p class="mt-2 text-sm md:text-base text-slate-600 dark:text-slate-300">
            Today is <span id="dateStr" class="font-medium"></span>. The time now is
            <span id="timeStr" class="font-semibold"></span>.
          </p>
        </div>
        <div class="w-full md:w-auto grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4">
          <a href="{% url 'store:home' %}" class="rounded-xl border border-primary-200/70 dark:border-slate-700 p-4 hover:shadow-soft bg-white/70 dark:bg-slate-900/60">
            <div class="text-[11px] uppercase tracking-wider text-slate-500 dark:text-slate-400">Quick Link</div>
            <div class="mt-1 font-semibold">Reports</div>
          </a>
          <a href="{% url 'assessment:assessment_list' %}" class="rounded-xl border border-primary-200/70 dark:border-slate-700 p-4 hover:shadow-soft bg-white/70 dark:bg-slate-900/60">
            <div class="text-[11px] uppercase tracking-wider text-slate-500 dark:text-slate-400">Quick Link</div>
            <div class="mt-1 font-semibold">Assessments</div>
          </a>
          <a href="{% url 'milling:milling_list' %}" class="rounded-xl border border-primary-200/70 dark:border-slate-700 p-4 hover:shadow-soft bg-white/70 dark:bg-slate-900/60">
            <div class="text-[11px] uppercase tracking-wider text-slate-500 dark:text-slate-400">Quick Link</div>
            <div class="mt-1 font-semibold">Milling</div>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Weather + KPIs -->
  <main class="mx-auto px-4 lg:px-6 mt-6 pb-14">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Weather -->
      <section class="lg:col-span-1">
        <div class="rounded-2xl bg-white/80 dark:bg-slate-900/70 border border-primary-100/60 dark:border-slate-800 p-6 shadow-soft">
          <div class="flex items-start justify-between">
            <div>
              <h2 class="text-lg font-semibold">Current Weather
                <span id="wDayBadge"
                  class="ml-2 text-[10px] uppercase tracking-wider rounded-full px-2 py-1 border border-primary-300/60 text-primary-700 dark:text-primary-300 dark:border-slate-700 align-middle">—</span>
              </h2>
              <p class="text-sm text-slate-500 dark:text-slate-400">Location:
                <span id="wPlace" class="font-medium">—</span>
              </p>
            </div>
            <div class="flex items-center gap-2">
              <button id="unitToggle"
                class="rounded-lg px-3 py-1.5 border text-sm border-primary-300 dark:border-slate-700 hover:bg-primary-50/70 dark:hover:bg-slate-800">°C / °F</button>
              <button id="refreshBtn"
                class="rounded-lg px-3 py-1.5 bg-primary-600 text-white text-sm hover:bg-primary-700 shadow-soft">Refresh</button>
            </div>
          </div>

          <!-- States -->
          <div id="weatherLoading" class="mt-4">
            <div class="h-6 w-40 rounded-md skeleton"></div>
            <div class="mt-2 h-10 w-28 rounded-md skeleton"></div>
            <div class="mt-2 h-20 rounded-xl skeleton"></div>
          </div>
          <div id="weatherError" class="mt-4 hidden text-sm text-rose-600"></div>

          <!-- Loaded -->
          <div id="weatherOk" class="hidden mt-4 space-y-5">
            <!-- Top row -->
            <div class="flex items-center gap-4">
              <img id="wIcon" alt="" class="h-14 w-14" />
              <div>
                <div class="text-2xl font-extrabold" id="wTemp">—</div>
                <div class="text-sm text-slate-600 dark:text-slate-300" id="wFeels">—</div>
                <div class="mt-1 text-sm" id="wText">—</div>
              </div>
            </div>

            <!-- Compact stats -->
            <div class="grid grid-cols-2 gap-3 text-sm">
              <div class="rounded-xl p-3 border border-slate-200 dark:border-slate-700 bg-white/60 dark:bg-slate-900/50">
                <div class="text-slate-500 dark:text-slate-400">Humidity</div>
                <div class="font-semibold" id="wHumidity">—</div>
              </div>
              <div class="rounded-xl p-3 border border-slate-200 dark:border-slate-700 bg-white/60 dark:bg-slate-900/50">
                <div class="text-slate-500 dark:text-slate-400">Wind</div>
                <div class="font-semibold" id="wWind">—</div>
              </div>
              <div class="rounded-xl p-3 border border-slate-200 dark:border-slate-700 bg-white/60 dark:bg-slate-900/50">
                <div class="text-slate-500 dark:text-slate-400">UV Index</div>
                <div class="font-semibold" id="wUV">—</div>
              </div>
              <div class="rounded-xl p-3 border border-slate-200 dark:border-slate-700 bg-white/60 dark:bg-slate-900/50">
                <div class="text-slate-500 dark:text-slate-400">Precip</div>
                <div class="font-semibold" id="wPrecip">—</div>
              </div>
            </div>

            <!-- Rich metrics -->
            <div class="grid grid-cols-2 gap-3 text-sm">
              <div class="rounded-xl p-3 border border-primary-100/60 dark:border-slate-700 bg-white/70 dark:bg-slate-900/50">
                <div class="text-slate-500 dark:text-slate-400">Pressure</div>
                <div class="font-semibold"><span id="wPressure">—</span> mb</div>
              </div>
              <div class="rounded-xl p-3 border border-primary-100/60 dark:border-slate-700 bg-white/70 dark:bg-slate-900/50">
                <div class="text-slate-500 dark:text-slate-400">Visibility</div>
                <div class="font-semibold"><span id="wVis">—</span> km</div>
              </div>
              <div class="rounded-xl p-3 border border-primary-100/60 dark:border-slate-700 bg-white/70 dark:bg-slate-900/50">
                <div class="text-slate-500 dark:text-slate-400">Dew Point</div>
                <div class="font-semibold"><span id="wDew">—</span>°</div>
              </div>
              <div class="rounded-xl p-3 border border-primary-100/60 dark:border-slate-700 bg-white/70 dark:bg-slate-900/50">
                <div class="text-slate-500 dark:text-slate-400">Gusts</div>
                <div class="font-semibold"><span id="wGust">—</span> km/h</div>
              </div>
            </div>

            <!-- Forecast -->
            <div>
              <div class="text-sm font-semibold mb-2">3-Day Forecast</div>
              <div id="forecastRow" class="grid grid-cols-3 gap-3"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- KPIs -->
      <section class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
        <div class="rounded-2xl border border-primary-100/60 dark:border-slate-800 bg-white/80 dark:bg-slate-900/70 p-6 shadow-soft">
          <div class="text-sm text-slate-500 dark:text-slate-400">Purchases Today</div>
          <div class="mt-2 text-3xl font-extrabold">{{ purchases_today|default:0 }}</div>
          <div class="mt-2 h-1.5 rounded-full bg-primary-100 dark:bg-slate-800">
            <div class="h-1.5 rounded-full bg-primary-500" style="width: 65%"></div>
          </div>
        </div>
        <div class="rounded-2xl border border-primary-100/60 dark:border-slate-800 bg-white/80 dark:bg-slate-900/70 p-6 shadow-soft">
          <div class="text-sm text-slate-500 dark:text-slate-400">Pending Payments</div>
          <div class="mt-2 text-3xl font-extrabold">{{ pending_count|default:0 }}</div>
          <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Awaiting finance action</p>
        </div>
        <div class="rounded-2xl border border-primary-100/60 dark:border-slate-800 bg-white/80 dark:bg-slate-900/70 p-6 shadow-soft">
          <div class="text-sm text-slate-500 dark:text-slate-400">Total Payable</div>
          <div class="mt-2 text-3xl font-extrabold">UGX {{ total_payable|default:"0.00" }}</div>
          <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Supplier accounts</p>
        </div>
      </section>
    </div>
  </main>

  <!-- Username for greeting -->
  <div id="userPayload" data-username="{{ request.user.get_full_name|default:request.user.username }}"></div>

  <!-- App Script -->
  <script>
    // ====== Config (fallback to your provided key & city) ======
    const params = new URLSearchParams(location.search);
    const API_KEY = params.get('apikey') || '41e63358947f461f94485541252309';
    const LOCATION_Q = params.get('q') || 'Kasese,Uganda';
    const BASE = 'https://api.weatherapi.com/v1';

    // ====== State ======
    const state = { unitC: true, current: null, forecast: null };

    // ====== DOM ======
    const el = {
      themeToggle: document.getElementById('themeToggle'),
      timeStr: document.getElementById('timeStr'),
      dateStr: document.getElementById('dateStr'),
      greeting: document.getElementById('greeting'),
      place: document.getElementById('wPlace'),
      dayBadge: document.getElementById('wDayBadge'),
      loading: document.getElementById('weatherLoading'),
      error: document.getElementById('weatherError'),
      ok: document.getElementById('weatherOk'),
      icon: document.getElementById('wIcon'),
      temp: document.getElementById('wTemp'),
      feels: document.getElementById('wFeels'),
      text: document.getElementById('wText'),
      humidity: document.getElementById('wHumidity'),
      wind: document.getElementById('wWind'),
      uv: document.getElementById('wUV'),
      precip: document.getElementById('wPrecip'),
      pressure: document.getElementById('wPressure'),
      vis: document.getElementById('wVis'),
      dew: document.getElementById('wDew'),
      gust: document.getElementById('wGust'),
      forecastRow: document.getElementById('forecastRow'),
      unitToggle: document.getElementById('unitToggle'),
      refreshBtn: document.getElementById('refreshBtn'),
      userPayload: document.getElementById('userPayload')
    };

    // ====== Utilities ======
    function iconUrl(path){ return !path ? '' : (path.startsWith('http') ? path : `https:${path}`); }
    function dir(deg){ const d=['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW']; return d[Math.round(deg/22.5)%16]; }
    async function fetchJSON(url){ const r=await fetch(url); if(!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); }

    // ====== Theme ======
    function applyThemeFromStorage(){
      const saved = localStorage.getItem('theme');
      if(saved === 'dark') document.documentElement.classList.add('dark');
      if(saved === 'light') document.documentElement.classList.remove('dark');
    }
    function toggleTheme(){
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }
    el.themeToggle?.addEventListener('click', toggleTheme);
    applyThemeFromStorage();

    // ====== Clock & Greeting ======
    function updateTime(){
      const now = new Date();
      el.timeStr.textContent = now.toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
      el.dateStr.textContent = now.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
      const hr = now.getHours();
      const base = hr < 12 ? 'Good Morning' : (hr < 17 ? 'Good Afternoon' : 'Good Evening');
      const username = (el.userPayload?.dataset?.username || '').trim();
      el.greeting.textContent = username ? `${base} ${username}` : base;
    }
    updateTime(); setInterval(updateTime, 1000);

    // ====== Renderers ======
    function renderTemps(cur){
      if(state.unitC){
        el.temp.textContent = `${Math.round(cur.temp_c)}°C`;
        el.feels.textContent = `Feels like ${Math.round(cur.feelslike_c)}°`;
      }else{
        el.temp.textContent = `${Math.round(cur.temp_f)}°F`;
        el.feels.textContent = `Feels like ${Math.round(cur.feelslike_f)}°`;
      }
    }

    function renderCurrent(){
      const cur = state.current?.current, loc = state.current?.location;
      if(!cur || !loc) return;

      el.place.textContent = `${loc.name}, ${loc.country}`;
      el.dayBadge.textContent = cur.is_day ? 'Day' : 'Night';

      el.icon.src = iconUrl(cur.condition.icon);
      el.icon.alt = cur.condition.text;
      renderTemps(cur);

      el.text.textContent = cur.condition.text;
      el.humidity.textContent = `${cur.humidity}%`;
      el.wind.textContent = `${Math.round(cur.wind_kph)} km/h ${dir(cur.wind_degree)}`;
      el.uv.textContent = cur.uv ?? '—';
      el.precip.textContent = `${cur.precip_mm ?? 0} mm`;

      el.pressure.textContent = cur.pressure_mb ?? '—';
      el.vis.textContent = cur.vis_km ?? '—';
      const dew = state.unitC ? cur.dewpoint_c : cur.dewpoint_f;
      el.dew.textContent = dew != null ? Math.round(dew) : '—';
      el.gust.textContent = Math.round(cur.gust_kph ?? 0);
    }

    function renderForecast(){
      const days = (state.forecast?.forecast?.forecastday || []).slice(0,3);
      el.forecastRow.innerHTML = '';
      for(const d of days){
        const max = state.unitC ? Math.round(d.day.maxtemp_c) : Math.round(d.day.maxtemp_f);
        const min = state.unitC ? Math.round(d.day.mintemp_c) : Math.round(d.day.mintemp_f);
        const card = document.createElement('div');
        card.className = 'rounded-xl border border-slate-200 dark:border-slate-700 p-3 text-center flex flex-col items-center gap-2 bg-white/60 dark:bg-slate-900/50';
        card.innerHTML = `
          <div class="text-xs font-medium text-gray-500 dark:text-gray-400">${new Date(d.date).toLocaleDateString('en-US',{weekday:'short'})}</div>
          <img src="${iconUrl(d.day.condition.icon)}" alt="${d.day.condition.text}" class="h-10 w-10" />
          <div class="text-sm text-gray-600 dark:text-gray-300">${d.day.condition.text}</div>
          <div class="text-sm font-semibold"><span>${max}°</span> / <span class="text-gray-500 dark:text-gray-400">${min}°</span></div>
        `;
        el.forecastRow.appendChild(card);
      }
    }

    // ====== Weather Fetch ======
    async function loadWeather(){
      el.loading.classList.remove('hidden');
      el.error.classList.add('hidden');
      el.ok.classList.add('hidden');

      try{
        const currentUrl = `${BASE}/current.json?key=${encodeURIComponent(API_KEY)}&q=${encodeURIComponent(LOCATION_Q)}&aqi=no`;
        const forecastUrl = `${BASE}/forecast.json?key=${encodeURIComponent(API_KEY)}&q=${encodeURIComponent(LOCATION_Q)}&days=3&aqi=no&alerts=no`;

        const [currentData, forecastData] = await Promise.allSettled([ fetchJSON(currentUrl), fetchJSON(forecastUrl) ]);

        if(currentData.status === 'fulfilled'){ state.current = currentData.value; renderCurrent(); }
        else { throw currentData.reason; }

        if(forecastData.status === 'fulfilled'){ state.forecast = forecastData.value; renderForecast(); }
        else { console.warn('Forecast failed:', forecastData.reason); }

        el.ok.classList.remove('hidden');
      }catch(err){
        console.error(err);
        el.error.textContent = `Unable to load weather: ${err.message}. Check API key, plan limits, or network.`;
        el.error.classList.remove('hidden');
      }finally{
        el.loading.classList.add('hidden');
      }
    }

    // ====== Events ======
    document.getElementById('unitToggle')?.addEventListener('click', () => {
      state.unitC = !state.unitC;
      if(state.current) renderCurrent();
      if(state.forecast) renderForecast();
    });
    document.getElementById('refreshBtn')?.addEventListener('click', loadWeather);

    // ====== Init ======
    loadWeather();
  </script>
