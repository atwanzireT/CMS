{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="min-h-screen">
  <main class="">
    {% include './dashboard/partials/weather_widget.html' %}

    <!-- Main Grid -->
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 xl:gap-8 mt-8">
      <!-- Modules Section -->
      <section class="xl:col-span-2">
        <div class="flex items-center justify-between mb-5 sm:mb-6">
          <div>
            <h2 class="text-2xl font-bold bg-gradient-to-r from-slate-900 to-slate-600 dark:from-white dark:to-slate-300 bg-clip-text text-transparent">
              Your Applications
            </h2>
            <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">Quick access to your modules and tools</p>
          </div>
          <div class="flex items-center gap-2">
            <span class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full text-xs font-medium bg-primary-100 text-primary-800 dark:bg-slate-800 dark:text-primary-300 border border-primary-200/70 dark:border-slate-700">
              <i class="fa-solid fa-grid-2"></i>
              {{ tiles|length }} modules
            </span>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-5 sm:gap-6">
          {% for tile in tiles %}
          <article class="group relative focus-within:ring-2 focus-within:ring-primary-400 rounded-2xl">
            <div class="absolute inset-0 rounded-2xl bg-gradient-to-r from-primary-600 to-indigo-600 blur-lg opacity-10 group-hover:opacity-20 transition"></div>

            <div
              class="relative rounded-2xl glass border shadow-soft hover:shadow-xl hover:translate-y-[-2px] hover:border-primary-200/70 dark:hover:border-slate-700 transition-all"
              data-module="{{ tile.key }}"
            >
              <div class="p-5 sm:p-6">
                <div class="flex items-start justify-between gap-3 mb-4">
                  <div class="flex min-w-0 items-center">
                    <div class="relative">
                      <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary-500 to-indigo-500 grid place-items-center shadow-soft">
                        <i class="fa-solid fa-{{ tile.icon }} text-white text-lg"></i>
                      </div>
                      <span class="absolute -top-1 -right-1 w-4 h-4 rounded-full bg-emerald-400 border-2 border-white dark:border-slate-900"></span>
                    </div>
                    <div class="ml-4 min-w-0">
                      <h3 class="text-base sm:text-lg font-semibold truncate text-slate-900 dark:text-white group-hover:text-primary-600 dark:group-hover:text-primary-300 transition-colors">
                        {{ tile.title }}
                      </h3>
                      <p class="text-sm text-slate-600 dark:text-slate-400 line-clamp-2">{{ tile.description }}</p>
                    </div>
                  </div>

                  <i class="fa-solid fa-chevron-right text-slate-400 group-hover:text-primary-500 group-hover:translate-x-1 transition"></i>
                </div>

                <!-- Module Stats -->
                <div class="space-y-3">
                  {% if tile.data.error %}
                    <div class="flex items-center p-3 rounded-xl bg-rose-50 dark:bg-rose-900/20 border border-rose-200 dark:border-rose-800">
                      <i class="fa-solid fa-triangle-exclamation text-rose-500 mr-2"></i>
                      <span class="text-sm text-rose-700 dark:text-rose-300">{{ tile.data.error }}</span>
                    </div>

                  {% elif tile.data.restricted %}
                    <div class="text-center py-3 rounded-xl bg-slate-100 dark:bg-slate-800">
                      <i class="fa-solid fa-lock text-slate-400 text-lg mb-1"></i>
                      <p class="text-sm text-slate-500 dark:text-slate-400">Access restricted</p>
                    </div>

                  {% else %}
                    {% with key=tile.key %}
                      {% if key == 'sales' and tile.data.show_detailed %}
                        <div class="grid grid-cols-2 gap-3">
                          <div class="text-center p-3 rounded-xl border bg-gradient-to-br from-emerald-50 to-green-50 dark:from-emerald-900/20 dark:to-green-900/20 border-emerald-200 dark:border-emerald-800">
                            <div class="text-xl font-bold text-emerald-700 dark:text-emerald-300">{{ tile.data.purchases_today }}</div>
                            <div class="text-[11px] text-emerald-600 dark:text-emerald-400 font-medium">Today</div>
                          </div>
                          <div class="text-center p-3 rounded-xl border bg-gradient-to-br from-sky-50 to-cyan-50 dark:from-sky-900/20 dark:to-cyan-900/20 border-sky-200 dark:border-sky-800">
                            <div class="text-xl font-bold text-sky-700 dark:text-sky-300">{{ tile.data.pending_count }}</div>
                            <div class="text-[11px] text-sky-600 dark:text-sky-400 font-medium">Pending</div>
                          </div>
                        </div>
                      {% endif %}

                      {% if key == 'finance' and tile.data.show_detailed %}
                        <div class="text-center p-4 rounded-xl border bg-gradient-to-r from-violet-50 to-fuchsia-50 dark:from-violet-900/20 dark:to-fuchsia-900/20 border-violet-200 dark:border-violet-800">
                          <div class="text-2xl font-bold bg-gradient-to-r from-violet-600 to-fuchsia-600 dark:from-violet-400 dark:to-fuchsia-400 bg-clip-text text-transparent">
                            UGX {{ tile.data.total_payable|default:0|intcomma }}
                          </div>
                          <div class="text-[11px] text-violet-600 dark:text-violet-400 font-medium mt-1">Total Payable</div>
                        </div>
                      {% endif %}

                      {% if key == 'quality' and tile.data.show_detailed %}
                        <div class="flex justify-between items-center p-3 rounded-xl border bg-gradient-to-r from-teal-50 to-emerald-50 dark:from-teal-900/20 dark:to-emerald-900/20 border-teal-200 dark:border-teal-800">
                          <div class="text-center">
                            <div class="text-lg font-bold text-emerald-600 dark:text-emerald-400">{{ tile.data.accepted_today|default:0 }}</div>
                            <div class="text-[11px] text-emerald-700 dark:text-emerald-300">Accepted</div>
                          </div>
                          <div class="h-8 w-px bg-teal-200 dark:bg-teal-700"></div>
                          <div class="text-center">
                            <div class="text-lg font-bold text-rose-600 dark:text-rose-400">{{ tile.data.rejected_today|default:0 }}</div>
                            <div class="text-[11px] text-rose-700 dark:text-rose-300">Rejected</div>
                          </div>
                        </div>
                      {% endif %}
                    {% endwith %}
                  {% endif %}
                </div>

                <div class="mt-4 pt-4 border-t border-slate-200/70 dark:border-slate-800/70">
                  <a href="{% if tile.url_name %}{% url tile.url_name %}{% else %}#{% endif %}"
                     class="inline-flex items-center text-sm font-medium text-primary-700 dark:text-primary-300 hover:text-primary-600">
                    Access Module
                    <i class="fa-solid fa-arrow-right ml-2 transition-transform group-hover:translate-x-1"></i>
                  </a>
                </div>
              </div>
            </div>
          </article>
          {% empty %}
          <div class="col-span-2 text-center py-16 rounded-2xl glass border">
            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-slate-100 dark:bg-slate-800 grid place-items-center">
              <i class="fa-solid fa-lock text-slate-400 text-2xl"></i>
            </div>
            <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-1">No modules available</h3>
            <p class="text-slate-500 dark:text-slate-400 text-sm">Contact the administrator for access.</p>
          </div>
          {% endfor %}
        </div>
      </section>

      <!-- Sidebar -->
      <aside class="space-y-6">
        <!-- Recent Activities -->
        <section class="glass rounded-2xl border shadow-soft">
          <div class="p-5 sm:p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Recent Activities</h3>
              <span class="px-2 py-1 text-xs font-medium rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200/70 dark:border-slate-700/70">
                {{ recent_activities|length }}
              </span>
            </div>

            <div class="space-y-4">
              {% for activity in recent_activities %}
              <div class="flex items-start gap-3">
                <div class="relative shrink-0">
                  <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary-500 to-indigo-500 grid place-items-center shadow-soft">
                    <i class="fa-solid fa-{{ activity.icon|default:'circle' }} text-white text-sm"></i>
                  </div>
                  <span class="absolute -bottom-1 -right-1 w-4 h-4 rounded-full bg-emerald-400 border-2 border-white dark:border-slate-900"></span>
                </div>
                <div class="min-w-0 flex-1">
                  <p class="text-sm font-medium text-slate-900 dark:text-white truncate">
                    {{ activity.user.get_full_name|default:activity.user.username }}
                  </p>
                  <p class="text-xs text-slate-600 dark:text-slate-400 mt-0.5">
                    {{ activity.get_action_display|default:activity.action }}
                  </p>
                  <p class="text-xs text-primary-700 dark:text-primary-300 font-medium mt-0.5">
                    {{ activity.timestamp|timesince }} ago
                  </p>
                </div>
              </div>
              {% empty %}
              <div class="text-center py-8">
                <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-slate-100 dark:bg-slate-800 grid place-items-center">
                  <i class="fa-solid fa-clock-rotate-left text-slate-400"></i>
                </div>
                <p class="text-sm text-slate-500 dark:text-slate-400">No recent activities</p>
              </div>
              {% endfor %}
            </div>

            {% if recent_activities %}
            <div class="mt-4 pt-4 border-t border-slate-200/70 dark:border-slate-800/70">
              <a href="#"
                 class="text-xs font-medium text-primary-700 dark:text-primary-300 hover:text-primary-600 inline-flex items-center gap-1">
                View all activities
                <i class="fa-solid fa-arrow-right"></i>
              </a>
            </div>
            {% endif %}
          </div>
        </section>

        <!-- Quick Actions -->
        <section class="glass rounded-2xl border shadow-soft">
          <div class="p-5 sm:p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Quick Actions</h3>
              <i class="fa-solid fa-bolt text-amber-400"></i>
            </div>

            <div class="space-y-2">
              {% if user_role == 'superuser' or user_role == 'management' or user_role == 'sales' %}
              <a href="{% url 'store:purchase_list' %}"
                 class="flex items-center p-3 rounded-xl text-sm border bg-white/70 dark:bg-slate-900/60 hover:bg-gradient-to-r hover:from-primary-50 hover:to-indigo-50 dark:hover:from-primary-900/20 dark:hover:to-indigo-900/20 hover:border-primary-200 dark:hover:border-slate-700 transition group">
                <span class="w-8 h-8 rounded-lg bg-gradient-to-br from-primary-500 to-indigo-500 grid place-items-center mr-3">
                  <i class="fa-solid fa-plus text-white text-xs"></i>
                </span>
                New Purchase
                <i class="fa-solid fa-chevron-right text-slate-400 ml-auto group-hover:text-primary-600 group-hover:translate-x-1 transition"></i>
              </a>
              {% endif %}

              {% if user_role == 'superuser' or user_role == 'management' or user_role == 'quality' %}
              <a href="{% url 'assessment:assessment_list' %}"
                 class="flex items-center p-3 rounded-xl text-sm border bg-white/70 dark:bg-slate-900/60 hover:bg-gradient-to-r hover:from-emerald-50 hover:to-green-50 dark:hover:from-emerald-900/20 dark:hover:to-green-900/20 hover:border-emerald-200 dark:hover:border-slate-700 transition group">
                <span class="w-8 h-8 rounded-lg bg-gradient-to-br from-emerald-500 to-green-500 grid place-items-center mr-3">
                  <i class="fa-solid fa-clipboard-check text-white text-xs"></i>
                </span>
                New Assessment
                <i class="fa-solid fa-chevron-right text-slate-400 ml-auto group-hover:text-emerald-600 group-hover:translate-x-1 transition"></i>
              </a>
              {% endif %}

              {% if user_role == 'superuser' or user_role == 'management' or user_role == 'finance' %}
              <a href="{% url 'finance:finance_dashboard' %}"
                 class="flex items-center p-3 rounded-xl text-sm border bg-white/70 dark:bg-slate-900/60 hover:bg-gradient-to-r hover:from-sky-50 hover:to-cyan-50 dark:hover:from-sky-900/20 dark:hover:to-cyan-900/20 hover:border-sky-200 dark:hover:border-slate-700 transition group">
                <span class="w-8 h-8 rounded-lg bg-gradient-to-br from-sky-500 to-cyan-500 grid place-items-center mr-3">
                  <i class="fa-solid fa-money-bill-wave text-white text-xs"></i>
                </span>
                Process Payment
                <i class="fa-solid fa-chevron-right text-slate-400 ml-auto group-hover:text-sky-600 group-hover:translate-x-1 transition"></i>
              </a>
              {% endif %}

              {% if user_role == 'superuser' or user_role == 'management' or user_role == 'milling' %}
              <a href="{% url 'milling:milling_list' %}"
                 class="flex items-center p-3 rounded-xl text-sm border bg-white/70 dark:bg-slate-900/60 hover:bg-gradient-to-r hover:from-amber-50 hover:to-orange-50 dark:hover:from-amber-900/20 dark:hover:to-orange-900/20 hover:border-amber-200 dark:hover:border-slate-700 transition group">
                <span class="w-8 h-8 rounded-lg bg-gradient-to-br from-amber-500 to-orange-500 grid place-items-center mr-3">
                  <i class="fa-solid fa-gear text-white text-xs"></i>
                </span>
                New Milling Process
                <i class="fa-solid fa-chevron-right text-slate-400 ml-auto group-hover:text-amber-600 group-hover:translate-x-1 transition"></i>
              </a>
              {% endif %}
            </div>
          </div>
        </section>

        <!-- Status Indicator -->
        <section class="rounded-2xl shadow-soft p-6 text-white bg-gradient-to-br from-primary-600 to-indigo-600">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold">System Status</h3>
            <span class="w-3 h-3 bg-emerald-400 rounded-full animate-pulse"></span>
          </div>
          <p class="text-sm/6 opacity-90">All systems operational</p>
          <div class="mt-2 flex items-center text-xs opacity-80">
            <i class="fa-solid fa-shield-halved mr-2"></i>
            <span>Last updated: {% now "M j, H:i" %}</span>
          </div>
        </section>
      </aside>
    </div>
  </main>
</div>

<style>
  .line-clamp-2 {
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
  }
</style>
{% endblock %}
